(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-fcbb339e"],{b30e:function(e,t,s){"use strict";s.r(t);var o=function(){var e=this,t=e._self._c;return t("div",{ref:"appContainer"},[t("el-image",{staticStyle:{"z-index":"999999",width:"100px"},attrs:{src:s("2559")},on:{click:e.shareFn}}),e.roomClient?t("div",{staticStyle:{margin:"0 auto","z-index":"999999"}},[e.me?t("peer-view",{attrs:{info:e.me,isMe:!0,audioTrack:e.me.audioTrack,videoTrack:e.me.videoTrack},on:{muteMic:function(t){return e.roomClient.muteMic()},unmuteMic:function(t){return e.roomClient.unmuteMic()},disableWebcam:function(t){return e.roomClient.disableWebcam()},enableWebcam:function(t){return e.roomClient.enableWebcam()},disableShare:function(t){return e.roomClient.disableShare()},enableShare:function(t){return e.roomClient.enableShare()}}}):e._e(),e._l(e.others,(function(e,s){return t("peer-view",{key:s,attrs:{info:e,audioTrack:e.audioTrack,videoTrack:e.videoTrack}})}))],2):e._e()],1)},i=[],n=(s("b7ef"),s("907a"),s("3c5d"),s("fa9e"),s("77d9"),s("41c3")),r=s("4ee7"),a=s("350d"),l=s("ac34"),c=s("2f62");const h={ClientSize:3};var d={components:{PeerView:r["a"]},data(){return{roomClient:{},roomId:this.getUUIDStr(5,16),peerId:this.getUUIDStr(8,16),me:null,others:[],started:!1,AngleValue:0,mobPreScreenX:0,savedCamera:{angle:0},showUi:!0,larksr:null,isShowMic:!0,isBestAngle:!0,isHandsUp:!1,showAction:!1,screenDialogVisible:!1,url:"",screenShotInfo:{},scence:null,scenceStatus:null,handsUpTimer:null,isHiCur:!1,isClapCur:!1,isCheerCur:!1,isJumpCur:!1}},methods:{shareGroupwechat(){if(navigator.share){const e={text:"平行云境.",url:"https://pxy-activity.oss-cn-beijing.aliyuncs.com/8W7GI1Vl/bg/65ab818fb929ffd16018f4f65980ee85_1660706287885.jpeg"};navigator.share(e)}},shareGroup(){const e={files:this.url,title:"平行云境"};navigator.share(e).then(e=>{console.log("分享成功")}).catch(e=>{console.log("分享失败",e)})},onStart(){this.started=!0},onEnd(){this.started=!1,this.mobPreScreenX=0},onMove(e){if(!this.started)return;let t,s;if(this.isMobile){if(0===this.mobPreScreenX)return this.mobPreScreenX=e.changedTouches[0].screenX,!1;s=(e.changedTouches[0].screenX-this.mobPreScreenX)/300*100,this.mobPreScreenX=e.changedTouches[0].screenX}else s=e.movementX/300*100;t=this.AngleValue-s,this.AngleValue=t,this.changeAngle(t)},changeAngle(e){var t;this.savedCamera.angle=e,null===(t=this.larksr)||void 0===t||t.sendTextToDataChannel(JSON.stringify({type:2,data:this.savedCamera}))},useMicClick(e){if(0===e){var t,s;const i=JSON.stringify({scope:2,type:19,token:this.token,data:{status:e}});null===(t=this.larksr)||void 0===t||t.sendTextToDataChannel(i);var o={code:6,message:i};null===(s=this.wsConnect)||void 0===s||s.send(JSON.stringify(o)),this.$store.commit("setHasMicAuth",!1)}else if(1===e){const t={activityId:this.localActivityId};Object(l["f"])(t).then(t=>{if(1e3===t.code){var s,o;const t=JSON.stringify({scope:2,type:19,token:this.token,data:{status:e}});null===(s=this.larksr)||void 0===s||s.sendTextToDataChannel(t),this.$store.commit("setHasMicAuth",!0);var i={code:6,message:t};null===(o=this.wsConnect)||void 0===o||o.send(JSON.stringify(i))}else this.$store.commit("setHasMicAuth",!1)})}},async shareFn(){if(console.log("_mediaSoupDevice",this.roomClient._mediaSoupDevice),!this.roomClient._mediaSoupDevice)return void this.$message.warning("mediaSoup service connect faild");const e={activityId:this.localActivityId};let t=!1;await Object(l["e"])(e).then(e=>{e?(1e3===e.code&&(t=!0),500===e.code&&(t=!1)):t=!1,t?(this.$route.query.roomId||this.$router.push({path:"/screen",query:{...this.$route.query,roomId:this.roomId}}),this.roomClient.enableShare()):(this.$store.commit("setIsShareScreen",!1),this.$store.commit("setHasScreenAuth",!1))})},disShareFn(){this.roomClient.disableShare();const e={activityId:this.$store.state.activityId,status:1};Object(l["m"])(e).then(e=>{e&&e.code})},screenShot(){this.larksr.captrueFrame((new Date).getTime())},screenCloseDialogFn(){this.url="",this.screenShotInfo={},this.screenDialogVisible=!1},downloadScreenImg(){this.downloadFile(this.screenShotInfo),this.screenCloseDialogFn()},dataURLtoBlob(e){var t=e.split(","),s=t[1].substring(0,t[1].length-2),o=t[0].match(/:(.*?);/)[1],i=atob(s),n=i.length,r=new Uint8Array(n);while(n--)r[n]=i.charCodeAt(n);return new Blob([r],{type:o})},downloadFile(e){const t=document.createElement("a");t.style.display="none";for(const s in e)t.setAttribute(s,e[s]);document.body.appendChild(t),t.click(),setTimeout(()=>{document.body.removeChild(t)},300)},bestAngleClick(e){var t;null===(t=this.larksr)||void 0===t||t.sendTextToDataChannel(JSON.stringify({scope:2,type:6,token:JSON.parse(this.$store.state.userInfo).token,data:{status:e}})),this.isBestAngle=!this.isBestAngle},handsUpClick(){var e,t;this.isHandsUp||(this.handsUpTimer&&clearTimeout(this.handsUpTimer),this.handsUpTimer=setTimeout(this.handsDownClick,15e3));const s=JSON.stringify({scope:2,type:3,token:JSON.parse(this.$store.state.userInfo).token,data:{status:1}});null===(e=this.larksr)||void 0===e||e.sendTextToDataChannel(s);var o={code:6,message:s};null===(t=this.wsConnect)||void 0===t||t.send(JSON.stringify(o)),this.isHandsUp=!0,this.$store.commit("setHasHandAuth",!0)},handsDownClick(){var e,t;const s=JSON.stringify({scope:2,type:3,token:JSON.parse(this.$store.state.userInfo).token,data:{status:0}});null===(e=this.larksr)||void 0===e||e.sendTextToDataChannel(s);var o={code:6,message:s};null===(t=this.wsConnect)||void 0===t||t.send(JSON.stringify(o)),this.isHandsUp=!1},handDownEmit(){var e;const t=JSON.stringify({scope:2,type:3,token:JSON.parse(this.$store.state.userInfo).token,data:{status:0}});null===(e=this.larksr)||void 0===e||e.sendTextToDataChannel(t),this.isHandsUp=!1},actionClick(e){var t;null===(t=this.larksr)||void 0===t||t.sendTextToDataChannel(JSON.stringify({scope:2,type:2,token:JSON.parse(this.$store.state.userInfo).token,data:{value:e}}))},actionIconClick(){this.showAction=!this.showAction},getUUIDStr(e,t){let s,o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),i=[];if(t=t||o.length,e)for(s=0;s<e;s++)i[s]=o[0|Math.random()*t];else{let e;for(i[8]=i[13]=i[18]=i[23]="-",i[14]="4",s=0;s<36;s++)i[s]||(e=0|16*Math.random(),i[s]=o[19==s?3&e|8:e])}return i.join("")},clientSize(e,t){var s;null===(s=this.larksr)||void 0===s||s.sendTextToDataChannel(JSON.stringify({type:h.ClientSize,data:{platform:"win32",width:e,height:t,scale:1}}))},sendConnectSuccess(e){const t={activityId:this.$store.state.activityId||localStorage.getItem("activityId"),memberId:this.$store.state.memberId||localStorage.getItem("memberId"),taskId:e};Object(l["B"])(t).then(e=>{e&&e.code})},connectAppli(){this.larksr=new a["LarkSR"]({rootElement:this.$refs["appContainer"],serverAddress:window["config"].LARKXR_SERVER_ADDRESS,scaleMode:"fill_clip",fullScreenMode:0,loadingBgUrl:"https://home-oss.pingxingyun.com/homePage/bg.jpg",mobileForceLandscape:!0,authCode:window["config"].SDK_AUTH_CODE,frameRate:60,codeRate:8e3}),this.larksr&&this.$store.commit("setLarksr",this.larksr),console.log("larksr",this.larksr,Object(a["LoadAppliParamsFromUrl"])()),this.larksr.isEnableTouchPonit=!1,this.larksr.connect({appliId:window["config"].LARKXR_APPLI_ID}).then(()=>{}).catch(e=>{console.log("load appli failed",e)}),this.larksr.on("connect",e=>{console.log("LarkSRClientEvent CONNECT",e)}),this.larksr.on("taskcreatesuccess",e=>{this.sendConnectSuccess(e.data.taskid)}),this.larksr.on("gotremotesteam",e=>{console.log("LarkSRClientEvent gotremotesteam",e)}),this.larksr.on("meidaloaded",e=>{console.log("LarkSRClientEvent meidaloaded",e),this.showUi=!0,this.larksr.openAudio().then(e=>{console.log("open audio success",e)}).catch(e=>{console.warn("open audio failed.",e);const t=navigator.userAgent,s=t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)||-1!=t.indexOf("Safari")&&-1!=t.indexOf("Version")&&"ontouchend"in document;s&&/micromessenger/i.test(t)&&this.$message.warning("iOS 微信浏览器不支持打开麦克风，请使用Safari访问音频功能")})}),this.larksr.on("mediaplaysuccess",e=>{console.log("LarkSRClientEvent mediaplaysuccess",e)}),this.larksr.on("mediaplayfailed",e=>{console.log("LarkSRClientEvent mediaplayfailed",e),this.isMediaplayfailed=!0}),this.larksr.on("meidaplaymute",e=>{console.log("LarkSRClientEvent meidaplaymute",e)}),this.larksr.on("loginsuccess",e=>{console.log("LarkSRClientEvent login success isPrestart",e.data.isPrestart)}),this.larksr.on("datachannelopen",e=>{var t;console.log("datachannel open",e),console.log(this.$store.state),null===(t=this.larksr)||void 0===t||t.sendTextToDataChannel(JSON.stringify({scope:2,type:0,token:JSON.parse(this.$store.state.userInfo).token,data:{memberId:this.$store.state.memberId,activityId:this.$store.state.activityId,apiUrl:window["config"].ZEUS_API_URL,signUrl:window["config"].SING_AND_LUCKY_URL+"/?memberId="+this.$store.state.memberId+"&activityId="+this.$store.state.activityId+"&token="+JSON.parse(this.$store.state.userInfo).token}})),console.log("签到页面",window["config"].SING_AND_LUCKY_URL+"/?memberId="+this.$store.state.memberId+"&activityId="+this.$store.state.activityId+"&token="+JSON.parse(this.$store.state.userInfo).token)}),this.larksr.on("aivoiceerror",e=>{alert(JSON.stringify(e.data))}),this.larksr.on("aivoicestatus",e=>{console.log("aivoicestatus",e)}),this.larksr.on("aivoiceasrresult",e=>{console.log("aivoiceasrresult",e.data)}),this.larksr.on("aivoicedmresult",e=>{try{let t=JSON.parse(e.data.text);console.log("aivoicedmresult",t)}catch(e){console.warn("parse aivoicedmresult failed",e.data)}}),this.larksr.on("datachanneltext",e=>{try{const t=JSON.parse(e.data);console.log("datachannel cmd",t),1===t.type?this.$store.commit("setPersonScenceInfo",JSON.stringify(t.data)):2===t.type&&this.$store.commit("setBgmResourceIndex",t.data.currentResource)}catch(t){console.log("parse datachannel json cmd failed",e.data)}}),this.larksr.on("error",e=>{console.error("LarkSRClientEvent error",e)}),this.larksr.on("operatetimeout",e=>{console.log("operatetimeout",e)}),this.larksr.on("close",e=>{console.log("close",e)}),this.larksr.on("appclose",e=>{console.log("appclose",e)}),this.larksr.on("info",e=>{console.log("LarkSRClientEvent info",e)}),this.larksr.on("captureframe",e=>{const t=e.data.base64,s={download:"截屏.png",href:t};this.url=t,this.screenShotInfo=s,this.screenDialogVisible=!0})}},computed:{hasMicAuth(){return this.$store.state.hasMicAuth},hasScreenAuth(){return this.$store.state.hasScreenAuth},hasHandAuth(){return this.$store.state.hasHandAuth},producerChange(){if(this.roomClient){const{_micProducer:e,_webcamProducer:t,_shareProducer:s,_device:o,_peerId:i}=this.roomClient;return{_micProducer:e,_webcamProducer:t,_shareProducer:s,_device:o,_peerId:i}}return null},consumerChange(){return this.roomClient?this.roomClient._consumers:null},localActivityId(){return this.$store.state.activityId},isShareScreenState(){return this.$store.state.isShareScreen},isMobile(){return this.$store.state.isMobile},isAdmin(){return this.$store.state.isAdminAuth},wsConnect(){return this.$store.state.ws},...Object(c["b"])(["showShareScreenTooltip","showShareScreenBanTooltip","showHandUpTooltip","showHandUpBanTooltip","hasHandAuth"])},watch:{roomClient:{handler(e){console.log("roomClient newValue",e);let t=e._consumers;if(t&&t.size>0){const e={};t.forEach(t=>{const{appData:{device:s,peerId:o,socketId:i},kind:n,track:r}=t;console.log(t),e[o]?"audio"==n?(e[o].audioTrack=r,e[o].audioConsumer=t):(e[o].videoTrack=r,e[o].videoConsumer=t):e[o]={device:s,peerId:o,audioTrack:"audio"==n?r:null,videoTrack:"video"==n?r:null,audioConsumer:"audio"==n?t:null,videoConsumer:"video"==n?t:null}});let s=[];for(let t in e)s.push(e[t]);this.others=s,console.log("this.others",this.others)}else this.others=[];console.log(this.others)},immediate:!0,deep:!0},producerChange(e,t){const{_micProducer:s,_webcamProducer:o,_shareProducer:i,_device:n,_peerId:r}=e;o||i?(this.me={videoTrack:o?o.track:i.track,audioProducer:s,videoProducer:o||i,device:n,peerId:r},console.log(this.me.videoTrack,"************************")):this.me={videoTrack:null,audioProducer:s,videoProducer:null,device:n,peerId:r}},consumerChange(e,t){},"this.$store.state.personScenceInfo":{handler(e){if(e){const t=JSON.parse(e);this.scence=t.loc,this.scenceStatus=t.act}},immediate:!0,deep:!0}},mounted(){this.connectAppli();let e="";const t=this.peerId;let s=this.$route.query;e=s.roomId?s.roomId:this.roomId;let o=new n["a"]({roomId:e,peerId:t});o.on("close",e=>{console.log("close",e)}),o.joinRoom(),this.roomClient=o,this.$store.commit("setRoomClient",o)},beforeUnmount(){this.larksr.app.disConnect(),this.larksr=null,this.$store.commit("setLarksr",null),this.handsUpTimer&&clearTimeout(this.handsUpTimer),this.roomClient.close("页面销毁"),this.$store.commit("setRoomClient",null)}},u=d,m=(s("cb1d"),s("2877")),p=Object(m["a"])(u,o,i,!1,null,"775b2312",null);t["default"]=p.exports},cb1d:function(e,t,s){"use strict";s("de10")},de10:function(e,t,s){}}]);
//# sourceMappingURL=chunk-fcbb339e.a94e5138.js.map