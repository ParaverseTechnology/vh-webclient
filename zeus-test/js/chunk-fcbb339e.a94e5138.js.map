{"version":3,"sources":["webpack:///./src/views/Screen.vue","webpack:///src/views/Screen.vue","webpack:///./src/views/Screen.vue?c80a","webpack:///./src/views/Screen.vue?c42e","webpack:///./src/views/Screen.vue?6fe1"],"names":["render","_vm","this","_c","_self","ref","staticStyle","attrs","require","on","shareFn","roomClient","me","audioTrack","videoTrack","$event","muteMic","unmuteMic","disableWebcam","enableWebcam","disableShare","enableShare","_e","_l","others","item","index","key","staticRenderFns","DataChannelType","ClientSize","components","PeerView","data","roomId","peerId","started","AngleValue","mobPreScreenX","savedCamera","angle","showUi","larksr","isShowMic","isBestAngle","isHandsUp","showAction","screenDialogVisible","url","screenShotInfo","scence","scenceStatus","handsUpTimer","isHiCur","isClapCur","isCheerCur","isJumpCur","methods","shareGroupwechat","text","navigator","shareGroup","files","title","console","catch","err","onStart","onEnd","onMove","screenXDiff","value","changeAngle","JSON","type","useMicClick","scope","token","status","code","message","activityId","apiAuthVoice","canShareScreen","path","query","disShareFn","apiScreenCallback","screenShot","screenCloseDialogFn","downloadScreenImg","dataURLtoBlob","bstr","n","u8arr","downloadFile","element","document","setTimeout","bestAngleClick","handsUpClick","handsDownClick","handDownEmit","actionClick","actionIconClick","getUUIDStr","radix","uuid","r","clientSize","platform","width","height","scale","sendConnectSuccess","memberId","taskId","sendTaskId","connectAppli","rootElement","serverAddress","scaleMode","fullScreenMode","loadingBgUrl","mobileForceLandscape","authCode","frameRate","codeRate","appliId","then","e","apiUrl","signUrl","alert","computed","hasMicAuth","hasScreenAuth","hasHandAuth","producerChange","_micProducer","_webcamProducer","_shareProducer","_device","_peerId","consumerChange","localActivityId","isShareScreenState","isMobile","isAdmin","wsConnect","watch","handler","_consumers","appData","device","socketId","kind","track","res","audioConsumer","videoConsumer","immediate","deep","audioProducer","videoProducer","mounted","beforeUnmount","component"],"mappings":"uHAAA,IAAIA,EAAS,WAAkB,IAAIC,EAAIC,KAAKC,EAAGF,EAAIG,MAAMD,GAAG,OAAOA,EAAG,MAAM,CAACE,IAAI,gBAAgB,CAACF,EAAG,WAAW,CAACG,YAAY,CAAC,UAAU,SAAS,MAAQ,SAASC,MAAM,CAAC,IAAMC,EAAQ,SAAuCC,GAAG,CAAC,MAAQR,EAAIS,WAAYT,EAAIU,WAAYR,EAAG,MAAM,CAACG,YAAY,CAAC,OAAS,SAAS,UAAU,WAAW,CAAEL,EAAIW,GAAIT,EAAG,YAAY,CAACI,MAAM,CAAC,KAAON,EAAIW,GAAG,MAAO,EAAK,WAAaX,EAAIW,GAAGC,WAAW,WAAaZ,EAAIW,GAAGE,YAAYL,GAAG,CAAC,QAAU,SAASM,GAAQ,OAAOd,EAAIU,WAAWK,WAAW,UAAY,SAASD,GAAQ,OAAOd,EAAIU,WAAWM,aAAa,cAAgB,SAASF,GAAQ,OAAOd,EAAIU,WAAWO,iBAAiB,aAAe,SAASH,GAAQ,OAAOd,EAAIU,WAAWQ,gBAAgB,aAAe,SAASJ,GAAQ,OAAOd,EAAIU,WAAWS,gBAAgB,YAAc,SAASL,GAAQ,OAAOd,EAAIU,WAAWU,kBAAkBpB,EAAIqB,KAAKrB,EAAIsB,GAAItB,EAAIuB,QAAQ,SAASC,EAAKC,GAAO,OAAOvB,EAAG,YAAY,CAACwB,IAAID,EAAMnB,MAAM,CAAC,KAAOkB,EAAK,WAAaA,EAAKZ,WAAW,WAAaY,EAAKX,kBAAiB,GAAGb,EAAIqB,MAAM,IAE5gCM,EAAkB,G,gHCuCtB,MAAMC,EAAkB,CAExBC,cAEe,OACfC,YACAC,iBAEAC,OACA,OACAtB,cACAuB,6BACAC,6BACAvB,QACAY,UACAY,WACAC,aACAC,gBACAC,aACAC,SAEAC,UACAC,YACAC,aACAC,eACAC,aACAC,cACAC,uBACAC,OACAC,kBACAC,YACAC,kBACAC,kBACAC,WACAC,aACAC,cACAC,eAGAC,SAEAC,mBACA,oBACA,SACAC,aACAX,wHAEAY,qBAIAC,aACA,SACAC,eACAC,cAEAH,4BACAI,sBACAC,MAAAC,IACAF,yBAIAG,UACA,iBAGAC,QACA,gBACA,sBAGAC,UACA,iBACA,OAEA,QACA,kBACA,0BAEA,OADA,gDACA,EAEAC,2DACA,oDAEAA,sBAEAC,oBACA,kBACA,qBAGAC,eAAA,MACA,yBACA,4DACAC,gBACAC,OACAzC,0BAKA0C,eACA,kBACA,wBACAC,QACAF,QACAG,iBACA5C,MACA6C,YAGA,+DACA,OAAAC,OAAAC,WACA,iEACA,4CACA,UAEA,SACAC,iCAEAC,2BACA,yBACA,wBACAN,QACAF,QACAG,iBACA5C,MACA6C,YAGA,+DACA,uCACA,OAAAC,OAAAC,WACA,sEAGA,2CAMA,gBAEA,GADAhB,kEACA,iCAEA,YADA,yDAIA,SACAiB,iCAEA,eACA,2BACA,GACA,eACAE,MACA,eACAA,OAGAA,KAGA,GACA,0BACA,mBACAC,eACAC,4BAAAnD,sBAGA,gCAEA,0CACA,8CAKAoD,aACA,+BACA,SACAL,wCACAH,UAEAS,2BACA,aAQAC,aACA,gDAGAC,sBACA,YACA,uBACA,6BAGAC,oBACA,uCACA,4BAEAC,iBACA,mBAEA,kCACA,2BACAC,UACAC,WACAC,oBACA,UACAA,qBAEA,qBACApB,UAGAqB,gBACA,oCACAC,uBACA,iBACAA,uBAEAC,6BACAD,UACAE,gBACAD,8BACA,MAGAE,kBAAA,MAEA,4DACA1B,gBACAG,QACAF,OACAG,mDACA5C,MACA6C,aAIA,oCAGAsB,eAAA,QACA,iBACA,mDACA,wDAEA,wBACAxB,QACAF,OACAG,mDACA5C,MACA6C,YAIA,+DACA,OAAAC,OAAAC,WACA,iEACA,kBACA,yCAGAqB,iBAAA,QACA,wBACAzB,QACAF,OACAG,mDACA5C,MACA6C,YAIA,+DACA,OAAAC,OAAAC,WACA,iEACA,mBAGAsB,eAAA,MACA,wBACA1B,QACAF,OACAG,mDACA5C,MACA6C,YAIA,+DAGA,mBAGAyB,eAAA,MACA,4DACA9B,gBACAG,QACAF,OACAG,mDACA5C,MACAsC,aAKAiC,kBACA,kCAEAC,gBACA,IACI,EADJ,6EACA,KAEA,GADAC,cACA,EACA,8CACA,CACA,MAGA,IAFAC,2BACAA,UACA,aACA,OACAC,qBACAD,uBAIA,mBAGAE,gBAAA,MACA,4DACApC,gBACAC,kBACAzC,MACA6E,iBACAC,QACAC,SACAC,aAMAC,sBACA,SACAjC,4EACAkC,sEACAC,UAEAC,2BACA,aAMAC,eAEA,6BACAC,uCAEAC,qDACAC,sBAEAC,iBAEAC,gEAEAC,wBACAC,wCAGAC,aACAC,eAEA,aACA,4CAEA/D,wEAEA,kCACA,qBACAgE,2CACAC,KAAA,QAEAhE,MAAAiE,IACAlE,qCAEA,6BACAA,6CAGA,uCACA,yCAEA,oCACAA,oDAEA,iCACAA,+CACA,eAEA,iCACAA,sCAEAC,MAAAiE,IACAlE,qCACA,4BACA,uHACA,8BACA,+DASA,sCACAA,sDAEA,qCACAA,mDACA,4BAEA,mCACAA,mDAGA,kCACAA,8EAEA,2CACAA,kCACAA,+BAEA,4DACAS,gBACAG,QACAF,OACAG,mDACA5C,MACAkF,oCACAlC,wCACAkD,qCACAC,4LAIApE,sMAEA,kCACAqE,gCAEA,mCACArE,iCAEA,sCACAA,yCAEA,qCACA,IACA,8BACAA,iCACA,SACAA,uDAGA,qCACA,IACA,2BACAA,iCAEA,WACA,iEACA,YACA,iEAEA,SACAA,2DAGA,2BACAA,6CAEA,oCACAA,kCAEA,2BACAA,yBAEA,8BACAA,4BAEA,0BACAA,0CAGA,kCACA,sBACA,GACA,kBACA,QAEA,WACA,sBACA,gCAIAsE,UAEAC,aACA,qCAGAC,gBACA,wCAGAC,cACA,sCAEAC,iBACA,oBACA,mBAAAC,kBAAAC,iBAAAC,UAAAC,UAAAC,GAAA,gBACA,OAAAJ,eAAAC,kBAAAC,iBAAAC,UAAAC,WAEA,aAEAC,iBACA,uBACA,2BAEA,MAGAC,kBACA,qCAGAC,qBACA,wCAGAC,WACA,mCAGAC,UACA,sCAEAC,YACA,gCAEA,gBACA,yBACA,4BACA,oBACA,uBACA,iBAGAC,OACA,YACAC,WACAvF,qCACA,mBACA,gBACA,WACAwF,cACA,MAAAC,gBAAAC,SAAAvH,WAAAwH,GAAA,KAAAC,QAAAC,GAAA,EACA7F,eACA,KACA,YACA8F,kBACAA,uBAEAA,kBACAA,sBAGAA,MACAJ,SACAvH,SACAtB,6BACAC,6BACAiJ,gCACAC,mCAIA,SACA,eACAxI,aAEA,cACAwC,4CAEA,eAEAA,0BAEAiG,aACAC,SAEAxB,oBACA,mBAAAC,kBAAAC,iBAAAC,UAAAC,UAAAC,GAAA,EACA,MACA,SAEAjI,6BACAqJ,gBACAC,mBACAV,SACAvH,UAEA6B,4DAEA,SAEAlD,gBACAqJ,gBACAC,mBACAV,SACAvH,WAIA6G,sBAqCA,sCACAO,WACA,MACA,sBACA,kBACA,0BAGAU,aACAC,UAGAG,UAEA,oBAEA,SACA,oBACA,wBAEAnI,EADA,SACAA,SAEAA,YAEA,kBAAAA,SAAAC,WACAxB,iBACAqD,yBAEArD,aACA,kBACA,uCAGA2J,gBACA,6BACA,iBACA,qCACA,mDACA,8BACA,2CCtvBgV,I,wBCQ5UC,EAAY,eACd,EACAvK,EACA4B,GACA,EACA,KACA,WACA,MAIa,aAAA2I,E,2CCnBf,W","file":"js/chunk-fcbb339e.a94e5138.js","sourcesContent":["var render = function render(){var _vm=this,_c=_vm._self._c;return _c('div',{ref:\"appContainer\"},[_c('el-image',{staticStyle:{\"z-index\":\"999999\",\"width\":\"100px\"},attrs:{\"src\":require('@/assets/images/bottom_touping.png')},on:{\"click\":_vm.shareFn}}),(_vm.roomClient)?_c('div',{staticStyle:{\"margin\":\"0 auto\",\"z-index\":\"999999\"}},[(_vm.me)?_c('peer-view',{attrs:{\"info\":_vm.me,\"isMe\":true,\"audioTrack\":_vm.me.audioTrack,\"videoTrack\":_vm.me.videoTrack},on:{\"muteMic\":function($event){return _vm.roomClient.muteMic()},\"unmuteMic\":function($event){return _vm.roomClient.unmuteMic()},\"disableWebcam\":function($event){return _vm.roomClient.disableWebcam()},\"enableWebcam\":function($event){return _vm.roomClient.enableWebcam()},\"disableShare\":function($event){return _vm.roomClient.disableShare()},\"enableShare\":function($event){return _vm.roomClient.enableShare()}}}):_vm._e(),_vm._l((_vm.others),function(item,index){return _c('peer-view',{key:index,attrs:{\"info\":item,\"audioTrack\":item.audioTrack,\"videoTrack\":item.videoTrack}})})],2):_vm._e()],1)\n}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","<template>\r\n  <div ref=\"appContainer\">\r\n    <el-image style=\"z-index:999999;width: 100px;height100px;\" @click=\"shareFn\" :src=\"require('@/assets/images/bottom_touping.png')\"></el-image>\r\n        <!-- <div style=\"position: relative;\">\r\n          <el-tooltip class=\"item\" effect=\"dark\" placement=\"top\" content=\"正在投屏，点击退出投屏\">\r\n            <el-image v-show=\"isShareScreenState&&hasScreenAuth\" @click=\"disShareFn\" :src=\"require('@/assets/images/bottom_touping_logout.png')\"></el-image>\r\n          </el-tooltip>\r\n          <el-tooltip class=\"item\" effect=\"dark\" placement=\"top\" content=\"可投屏\">\r\n            <el-image v-show=\"hasScreenAuth&&!isShareScreenState\" @click=\"shareFn\" :src=\"require('@/assets/images/bottom_touping.png')\"></el-image>\r\n          </el-tooltip>\r\n          <el-tooltip class=\"item\" effect=\"dark\" placement=\"top\" content=\"禁止投屏\">\r\n            <el-image v-show=\"!hasScreenAuth\" :src=\"require('@/assets/images/bottom_touping_ban.png')\"></el-image>\r\n          </el-tooltip>\r\n          <div v-if=\"showShareScreenTooltip&&!isAdmin\" class=\"handle-btn-tooptip\">\r\n            <p>已允许投屏</p>\r\n          </div>\r\n          <div v-if=\"showShareScreenBanTooltip&&!isAdmin\" class=\"handle-btn-tooptip\">\r\n            <p>已禁止投屏</p>\r\n          </div>\r\n        </div> -->\r\n      <!-- 共享房间 -->\r\n      <div v-if=\"roomClient\" style=\"margin: 0 auto;z-index: 999999;\">\r\n        <peer-view v-if=\"me\" :info=\"me\" :isMe=\"true\" :audioTrack=\"me.audioTrack\" :videoTrack=\"me.videoTrack\"\r\n                  @muteMic=\"roomClient.muteMic()\"\r\n                  @unmuteMic=\"roomClient.unmuteMic()\"\r\n                  @disableWebcam=\"roomClient.disableWebcam()\"\r\n                  @enableWebcam=\"roomClient.enableWebcam()\"\r\n                  @disableShare=\"roomClient.disableShare()\"\r\n                  @enableShare=\"roomClient.enableShare()\"\r\n        ></peer-view>\r\n        <peer-view v-for=\"(item,index) in others\" :key=\"index\" :info=\"item\" :audioTrack=\"item.audioTrack\" :videoTrack=\"item.videoTrack\"></peer-view>\r\n      </div>\r\n  </div>\r\n</template>\r\n<script>\r\nimport RoomClient from \"./enterAppli/js/RoomClient\";\r\nimport PeerView from \"./enterAppli/PeerView\";\r\nimport { LarkSR, LoadAppliParamsFromUrl } from \"larksr_websdk\";\r\nimport { apiAuthScreen, apiAuthVoice, sendTaskId, apiScreenCallback } from '@/apis/api'\r\nimport { mapGetters } from 'vuex';\r\n\r\nconst DataChannelType = {\r\n  // 客⼾端⼤⼩\r\n  ClientSize: 3,\r\n};\r\nexport default {\r\n  components: { \r\n    PeerView,\r\n  },\r\n  data() {\r\n    return {\r\n      roomClient: {},\r\n      roomId:this.getUUIDStr(5,16),//房间号\r\n      peerId:this.getUUIDStr(8,16),//用户id\r\n      me:null,\r\n      others:[],\r\n      started: false, // 旋转角度是否开始\r\n      AngleValue: 0, // 角度\r\n      mobPreScreenX: 0, // 移动端计算滑动点需记住上一次坐标点\r\n      savedCamera: {\r\n        angle: 0,\r\n      },\r\n      showUi: true,\r\n      larksr: null,\r\n      isShowMic: true, // 是否允许使用麦克风\r\n      isBestAngle: true, // 是否是最佳视角\r\n      isHandsUp: false, // 是否举手\r\n      showAction: false, // 展示动作面板\r\n      screenDialogVisible: false, // 截屏弹窗\r\n      url: '',\r\n      screenShotInfo: {},\r\n      scence: null, // 场景值\r\n      scenceStatus: null, //场景状态：进入、离开\r\n      handsUpTimer: null, // 举手的timer 定时15秒\r\n      isHiCur: false,\r\n      isClapCur: false,\r\n      isCheerCur: false,\r\n      isJumpCur: false\r\n    }\r\n  },\r\n  methods: {\r\n    // 分享到微信\r\n    shareGroupwechat() {\r\n      if(navigator.share) {\r\n        const shareOpts = {\r\n          text: '平行云境.',\r\n          url: 'https://pxy-activity.oss-cn-beijing.aliyuncs.com/8W7GI1Vl/bg/65ab818fb929ffd16018f4f65980ee85_1660706287885.jpeg',\r\n        };\r\n        navigator.share(shareOpts);\r\n      }\r\n    },\r\n    // 分享到朋友圈\r\n    shareGroup() {\r\n      const shareOpts = {\r\n        files: this.url,\r\n        title: '平行云境'\r\n      };\r\n      navigator.share(shareOpts).then(res => {\r\n        console.log('分享成功')\r\n      }).catch(err => {\r\n        console.log('分享失败', err)\r\n      })\r\n    },\r\n    // 旋转角度start\r\n    onStart() {\r\n      this.started = true;\r\n    },\r\n    // 旋转角度end\r\n    onEnd() {\r\n      this.started = false;\r\n      this.mobPreScreenX = 0;\r\n    },\r\n    // 旋转角度move\r\n    onMove(e) {\r\n      if (!this.started) {\r\n        return;\r\n      }\r\n      let value,screenXDiff;\r\n      if (this.isMobile) {\r\n        if (this.mobPreScreenX === 0) {\r\n          this.mobPreScreenX = e.changedTouches[0].screenX;\r\n          return false;\r\n        }\r\n        screenXDiff = ((e.changedTouches[0].screenX - this.mobPreScreenX) / 300) * 100;\r\n        this.mobPreScreenX = e.changedTouches[0].screenX;\r\n      } else {\r\n        screenXDiff = (e.movementX / 300) * 100;\r\n      }\r\n      value = this.AngleValue - screenXDiff;\r\n      this.AngleValue = value;\r\n      this.changeAngle(value);\r\n    },\r\n    // 切换摄像机角度\r\n    changeAngle(angle) {\r\n      this.savedCamera.angle = angle;\r\n      this.larksr?.sendTextToDataChannel(\r\n        JSON.stringify({\r\n          type: 2,\r\n          data: this.savedCamera,\r\n        })\r\n      );\r\n    },\r\n    // 麦克风点击\r\n    useMicClick(status) {\r\n      if(status === 0) {\r\n        const jsonData = JSON.stringify({\r\n          scope: 2,\r\n          type: 19,\r\n          token: this.token,\r\n          data: {\r\n            status: status,\r\n          }\r\n        })\r\n        this.larksr?.sendTextToDataChannel(jsonData)\r\n        var message = {code:6,message:jsonData}\r\n        this.wsConnect?.send(JSON.stringify(message))\r\n        this.$store.commit('setHasMicAuth', false);\r\n      } else if(status === 1) {\r\n        // 获取麦克风权限\r\n        const params = {\r\n          activityId: this.localActivityId\r\n        }\r\n        apiAuthVoice(params).then(res => {\r\n          if(res.code === 1000) {// 允许开麦\r\n            const jsonData = JSON.stringify({\r\n              scope: 2,\r\n              type: 19,\r\n              token: this.token,\r\n              data: {\r\n                status: status,\r\n              }\r\n            })\r\n            this.larksr?.sendTextToDataChannel(jsonData)\r\n            this.$store.commit('setHasMicAuth', true);\r\n            var message = {code:6,message:jsonData}\r\n            this.wsConnect?.send(JSON.stringify(message))\r\n          } else {\r\n            // 没有权限-直接关闭麦克风\r\n            this.$store.commit('setHasMicAuth', false);\r\n          }\r\n        })\r\n      }\r\n    },\r\n    // 投屏\r\n    async shareFn() {\r\n      console.log('_mediaSoupDevice', this.roomClient._mediaSoupDevice)\r\n      if(!this.roomClient._mediaSoupDevice) {\r\n        this.$message.warning('mediaSoup service connect faild');\r\n        return\r\n      }\r\n      // 投屏校验\r\n      const params = {\r\n        activityId: this.localActivityId\r\n      }\r\n      let canShareScreen = false // 不允许投屏 500\r\n      await apiAuthScreen(params).then(res => {\r\n        if(res) {\r\n          if(res.code === 1000) {// 允许投屏\r\n            canShareScreen = true\r\n          }if(res.code === 500) {\r\n            canShareScreen = false\r\n          }\r\n        } else {\r\n          canShareScreen = false\r\n        }\r\n        // 允许投屏\r\n        if(canShareScreen) {\r\n          if(!this.$route.query.roomId) {\r\n            this.$router.push({\r\n              path: '/screen',\r\n              query: { ...this.$route.query, roomId: this.roomId,}\r\n            })\r\n          }\r\n          this.roomClient.enableShare();\r\n        } else {// 不允许投屏\r\n         this.$store.commit('setIsShareScreen', false);\r\n         this.$store.commit('setHasScreenAuth', false)\r\n        }\r\n      })\r\n    },\r\n    // 结束投屏\r\n    disShareFn() {\r\n      this.roomClient.disableShare();\r\n      const params = {\r\n        activityId: this.$store.state.activityId,\r\n        status: 1\r\n      }\r\n      apiScreenCallback(params).then(res => {\r\n        if(res && res.code === 1000) {\r\n          \r\n        }\r\n      })\r\n      // this.isShareScreen = true;\r\n      // this.$store.commit('setIsShareScreen', false);\r\n    },\r\n    // 截屏\r\n    screenShot() {\r\n      this.larksr.captrueFrame(new Date().getTime());\r\n    },\r\n    // 截屏弹窗关闭\r\n    screenCloseDialogFn() {\r\n      this.url = '';\r\n      this.screenShotInfo = {};\r\n      this.screenDialogVisible = false;\r\n    },\r\n    // 保存屏幕截图\r\n    downloadScreenImg() {\r\n      this.downloadFile(this.screenShotInfo);\r\n      this.screenCloseDialogFn();\r\n    },\r\n    dataURLtoBlob(dataurl) {\r\n      var arr = dataurl.split(',');\r\n        //注意base64的最后面中括号和引号是不转译的   \r\n        var _arr = arr[1].substring(0,arr[1].length-2);\r\n        var mime = arr[0].match(/:(.*?);/)[1],\r\n          bstr =atob(_arr),\r\n          n = bstr.length,\r\n          u8arr = new Uint8Array(n);\r\n        while (n--) {\r\n          u8arr[n] = bstr.charCodeAt(n);\r\n        }\r\n        return new Blob([u8arr], {\r\n          type: mime\r\n        });\r\n    },\r\n    downloadFile(saveInfo) {\r\n      const element = document.createElement('a');\r\n      element.style.display = 'none';\r\n      for (const key in saveInfo) {\r\n        element.setAttribute(key, saveInfo[key]);\r\n      }\r\n      document.body.appendChild(element);\r\n      element.click();\r\n      setTimeout(() => {\r\n        document.body.removeChild(element);\r\n      }, 300)\r\n    },\r\n    // 最佳视角点击\r\n    bestAngleClick(status) {\r\n      // status 0 - 不显示， 1 - 显示;\r\n      this.larksr?.sendTextToDataChannel(\r\n        JSON.stringify({\r\n          scope: 2,\r\n          type: 6,\r\n          token: JSON.parse(this.$store.state.userInfo).token,\r\n          data: {\r\n            status: status\r\n          }\r\n        })\r\n      )\r\n      this.isBestAngle = !this.isBestAngle;\r\n    },\r\n    // 举手\r\n    handsUpClick() {\r\n      if(!this.isHandsUp) {\r\n        if(this.handsUpTimer) clearTimeout(this.handsUpTimer);\r\n        this.handsUpTimer = setTimeout(this.handsDownClick,15000);\r\n      }\r\n       const jsonData = JSON.stringify({\r\n          scope: 2,\r\n          type: 3,\r\n          token: JSON.parse(this.$store.state.userInfo).token,\r\n          data: {\r\n            status: 1\r\n          }\r\n        })\r\n      // status 0 - 放下 1 - 举手;\r\n      this.larksr?.sendTextToDataChannel(jsonData)\r\n       var message = {code:6,message:jsonData}\r\n      this.wsConnect?.send(JSON.stringify(message))\r\n      this.isHandsUp = true;\r\n      this.$store.commit('setHasHandAuth', true)\r\n    },\r\n    // 放下举手\r\n    handsDownClick() {\r\n      const jsonData = JSON.stringify({\r\n          scope: 2,\r\n          type: 3,\r\n          token: JSON.parse(this.$store.state.userInfo).token,\r\n          data: {\r\n            status: 0\r\n          }\r\n        })\r\n      // status 0 - 放下 1 - 举手;\r\n      this.larksr?.sendTextToDataChannel(jsonData)\r\n       var message = {code:6,message:jsonData}\r\n      this.wsConnect?.send(JSON.stringify(message))\r\n      this.isHandsUp = false;\r\n    },\r\n    // 举手图标修改为放下\r\n    handDownEmit() {\r\n      const jsonData = JSON.stringify({\r\n          scope: 2,\r\n          type: 3,\r\n          token: JSON.parse(this.$store.state.userInfo).token,\r\n          data: {\r\n            status: 0\r\n          }\r\n        })\r\n      // status 0 - 放下 1 - 举手;\r\n      this.larksr?.sendTextToDataChannel(jsonData)\r\n      //  var message = {code:6,message:jsonData}\r\n      // this.wsConnect?.send(JSON.stringify(message))\r\n      this.isHandsUp = false;\r\n    },\r\n    // 动作\r\n    actionClick(type) {\r\n      this.larksr?.sendTextToDataChannel(\r\n        JSON.stringify({\r\n          scope: 2,\r\n          type: 2,\r\n          token: JSON.parse(this.$store.state.userInfo).token,\r\n          data: {\r\n            value: type\r\n          }\r\n        })\r\n      )\r\n    },\r\n    actionIconClick() {\r\n      this.showAction = !this.showAction;\r\n    },\r\n    getUUIDStr(len, radix) {\r\n        let chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');\r\n        let uuid = [],i;\r\n        radix = radix || chars.length;\r\n        if (len) {\r\n          for (i = 0; i < len; i++) uuid[i] = chars[0 | Math.random() * radix];\r\n        } else {\r\n          let r;\r\n          uuid[8] = uuid[13] = uuid[18] = uuid[23] = '-';\r\n          uuid[14] = '4';\r\n          for (i = 0; i < 36; i++) {\r\n            if (!uuid[i]) {\r\n              r = 0 | Math.random() * 16;\r\n              uuid[i] = chars[(i == 19) ? (r & 0x3) | 0x8 : r];\r\n            }\r\n          }\r\n        }\r\n        return uuid.join('');\r\n    },\r\n    // 客户端大小\r\n    clientSize(width, height) {\r\n      this.larksr?.sendTextToDataChannel(\r\n        JSON.stringify({\r\n          type: DataChannelType.ClientSize,\r\n          data: {\r\n            platform: \"win32\",\r\n            width,\r\n            height,\r\n            scale: 1,\r\n          },\r\n        })\r\n      );\r\n    },\r\n    // 进入应用成功、给后台传参\r\n    sendConnectSuccess(taskId) {\r\n      const params = {\r\n        activityId: this.$store.state.activityId || localStorage.getItem('activityId'),\r\n        memberId: this.$store.state.memberId || localStorage.getItem('memberId'),\r\n        taskId: taskId\r\n      }\r\n      sendTaskId(params).then(res => {\r\n        if(res && res.code === 1000) {\r\n\r\n        }\r\n      })\r\n    },\r\n    // 进入应用\r\n    connectAppli() {\r\n      // 直接调用进入应用接口创建实例，自动配置连接云端资源\r\n      this.larksr = new LarkSR({\r\n        rootElement: this.$refs[\"appContainer\"],\r\n        // 服务器地址\r\n        serverAddress: window['config'].LARKXR_SERVER_ADDRESS,\r\n        scaleMode: \"fill_clip\",\r\n        // 0 -》 用户手动触发, 1 -》 首次点击进入触发, 2 -》 每次点击触发\r\n        fullScreenMode: 0,\r\n        // 测试载入背景图\r\n        loadingBgUrl: \"https://home-oss.pingxingyun.com/homePage/bg.jpg\",\r\n        // 手机端是否强制横屏\r\n        mobileForceLandscape: true,\r\n        authCode: window['config'].SDK_AUTH_CODE,\r\n        // authCode: '6b09421012994a2bba959b556fc2b78f',\r\n        // authCode: '5966b6569bec4f879322a8c91f2f2cd4', // 55环境\r\n        frameRate: 60,\r\n        codeRate: 8000,\r\n      });\r\n      if(this.larksr) {\r\n        this.$store.commit('setLarksr', this.larksr)\r\n      }\r\n      console.log('larksr', this.larksr, LoadAppliParamsFromUrl());\r\n      // 关闭触摸中间的点\r\n      this.larksr.isEnableTouchPonit = false;\r\n      this.larksr.connect({ \r\n        appliId: window['config'].LARKXR_APPLI_ID,\r\n      }).then(() => {\r\n\r\n      }).catch((e) => {\r\n        console.log(\"load appli failed\", e);\r\n      });\r\n      this.larksr.on(\"connect\", (e) => {\r\n        console.log(\"LarkSRClientEvent CONNECT\", e);\r\n      });\r\n      // TASK 创建成功，返回 Task 相关信息\r\n      this.larksr.on(\"taskcreatesuccess\", (e) => {\r\n        this.sendConnectSuccess(e.data.taskid)\r\n      });\r\n      this.larksr.on(\"gotremotesteam\", (e) => {\r\n        console.log(\"LarkSRClientEvent gotremotesteam\", e);\r\n      });\r\n      this.larksr.on(\"meidaloaded\", (e) => {\r\n        console.log(\"LarkSRClientEvent meidaloaded\", e);\r\n        this.showUi = true;\r\n        // 打开麦克风\r\n        this.larksr.openAudio() .then((res) => {\r\n          console.log(\"open audio success\", res);\r\n          // this.audioTrackEnable = this.audioTrack.enabled;\r\n        }).catch((e) => {\r\n          console.warn(\"open audio failed.\", e);\r\n          const u = navigator.userAgent; \r\n          const isIos = u.match(/\\(i[^;]+;( U;)? CPU.+Mac OS X/) || (u.indexOf('Safari') != -1 && u.indexOf(\"Version\") != -1 && 'ontouchend' in document);\r\n          if (isIos && (/micromessenger/i).test(u)) {\r\n            this.$message.warning(\"iOS 微信浏览器不支持打开麦克风，请使用Safari访问音频功能\");\r\n          } \r\n          // else if (window.location.href.indexOf(\"https\") == -1) {\r\n          //   this.$message.warning(\"请通过 HTTPS 连接访问音频功能\");\r\n          // } else {\r\n          //   this.$message.error(JSON.stringify(e));\r\n          // }\r\n        });\r\n      });\r\n      this.larksr.on(\"mediaplaysuccess\", (e) => {\r\n        console.log(\"LarkSRClientEvent mediaplaysuccess\", e);\r\n      });\r\n      this.larksr.on(\"mediaplayfailed\", (e) => {\r\n        console.log(\"LarkSRClientEvent mediaplayfailed\", e);\r\n        this.isMediaplayfailed = true;\r\n      });\r\n      this.larksr.on(\"meidaplaymute\", (e) => {\r\n        console.log(\"LarkSRClientEvent meidaplaymute\", e);\r\n      });\r\n      // 是否是预启动\r\n      this.larksr.on(\"loginsuccess\", (e) => {\r\n        console.log(\"LarkSRClientEvent login success isPrestart\", e.data.isPrestart);\r\n      });\r\n      this.larksr.on(\"datachannelopen\", (e) => {\r\n        console.log(\"datachannel open\", e);\r\n        console.log(this.$store.state)\r\n        // 传递给应用身份信息\r\n        this.larksr?.sendTextToDataChannel(\r\n          JSON.stringify({\r\n            scope: 2,\r\n            type: 0,\r\n            token: JSON.parse(this.$store.state.userInfo).token,\r\n            data: {\r\n              memberId: this.$store.state.memberId,\r\n              activityId: this.$store.state.activityId,\r\n              apiUrl: window['config'].ZEUS_API_URL,\r\n              signUrl: window['config'].SING_AND_LUCKY_URL+'/?memberId='+this.$store.state.memberId+'&activityId='+this.$store.state.activityId+'&token='+JSON.parse(this.$store.state.userInfo).token\r\n            }\r\n          })\r\n        )\r\n      console.log('签到页面',window['config'].SING_AND_LUCKY_URL+'/?memberId='+this.$store.state.memberId+'&activityId='+this.$store.state.activityId+'&token='+JSON.parse(this.$store.state.userInfo).token)\r\n      });\r\n      this.larksr.on('aivoiceerror', (e) => {\r\n        alert(JSON.stringify(e.data));\r\n      });\r\n      this.larksr.on('aivoicestatus', (e) => {\r\n        console.log('aivoicestatus', e);\r\n      });\r\n      this.larksr.on('aivoiceasrresult', (e) => {\r\n        console.log('aivoiceasrresult', e.data);\r\n      });\r\n      this.larksr.on('aivoicedmresult', (e) => {\r\n        try {\r\n          let res = JSON.parse(e.data.text);\r\n          console.log('aivoicedmresult', res);\r\n        } catch(e) {\r\n          console.warn('parse aivoicedmresult failed', e.data);\r\n        }\r\n      });\r\n      this.larksr.on(\"datachanneltext\", (e) => {\r\n        try {\r\n          const cmd = JSON.parse(e.data);\r\n          console.log('datachannel cmd', cmd);\r\n          // TODO:数据通道接收消息\r\n          if(cmd.type===1) { // 接收场景值信息\r\n            this.$store.commit('setPersonScenceInfo',JSON.stringify(cmd.data))\r\n          }else if(cmd.type===2) {// 背景音乐循环播放时，播放下一首通知播放的index\r\n            this.$store.commit('setBgmResourceIndex',cmd.data.currentResource)\r\n          }\r\n        } catch(ext) {\r\n          console.log('parse datachannel json cmd failed', e.data);\r\n        }\r\n      });\r\n      this.larksr.on(\"error\", (e) => {\r\n        console.error(\"LarkSRClientEvent error\", e);\r\n      });\r\n      this.larksr.on(\"operatetimeout\", (e) => { // 无操作超时时触发\r\n        console.log('operatetimeout',e)\r\n      })\r\n      this.larksr.on(\"close\", (e) => { // 连接关闭时触发\r\n        console.log('close',e)\r\n      })\r\n      this.larksr.on(\"appclose\", (e) => { // 云端应用关闭，但连接未关闭\r\n        console.log('appclose',e)\r\n      })\r\n      this.larksr.on(\"info\", (e) => {\r\n        console.log(\"LarkSRClientEvent info\", e);\r\n      });\r\n      // 监听到截屏成功事件\r\n      this.larksr.on(\"captureframe\", (e) => {\r\n        const capture = e.data.base64;\r\n        const saveInfo = {\r\n          'download': `截屏.png`,\r\n          'href': capture\r\n        };\r\n        this.url = capture;\r\n        this.screenShotInfo = saveInfo;\r\n        this.screenDialogVisible = true;\r\n      });\r\n    },\r\n  },\r\n  computed:{\r\n    // 是否允许使用麦克风\r\n    hasMicAuth() {\r\n      return this.$store.state.hasMicAuth;\r\n    },\r\n    // 是否允许投屏\r\n    hasScreenAuth() {\r\n      return this.$store.state.hasScreenAuth;\r\n    },\r\n    // 是否举手\r\n    hasHandAuth() {\r\n      return this.$store.state.hasHandAuth;\r\n    },\r\n    producerChange(){\r\n      if(this.roomClient){\r\n        const {_micProducer,_webcamProducer,_shareProducer,_device,_peerId} = this.roomClient;\r\n        return { _micProducer,_webcamProducer,_shareProducer,_device,_peerId }\r\n      }\r\n      return null;\r\n    },\r\n    consumerChange(){\r\n      if(this.roomClient){\r\n        return this.roomClient._consumers;\r\n      }\r\n      return null;\r\n    },\r\n    // 活动id\r\n    localActivityId() {\r\n      return this.$store.state.activityId\r\n    },\r\n    // 是否正在投屏\r\n    isShareScreenState() {\r\n      return this.$store.state.isShareScreen\r\n    },\r\n    // 是否是手机端\r\n    isMobile() {\r\n      return this.$store.state.isMobile\r\n    },\r\n    // 是否是管理员角色\r\n    isAdmin() {\r\n      return this.$store.state.isAdminAuth\r\n    },\r\n    wsConnect() {\r\n      return this.$store.state.ws\r\n    },\r\n    ...mapGetters([\r\n      'showShareScreenTooltip',\r\n      'showShareScreenBanTooltip',\r\n      'showHandUpTooltip',\r\n      'showHandUpBanTooltip',\r\n      'hasHandAuth'\r\n    ])\r\n  },\r\n  watch:{\r\n    'roomClient': {\r\n      handler(newValue) {\r\n        console.log('roomClient newValue', newValue)\r\n        let _consumers = newValue._consumers\r\n        if(_consumers && _consumers.size>0){\r\n        const res= {};\r\n        _consumers.forEach(item=>{\r\n          const {appData:{device,peerId,socketId},kind,track}=item;\r\n          console.log(item)\r\n          if(res[peerId]){\r\n            if(kind=='audio'){\r\n              res[peerId].audioTrack=track;\r\n              res[peerId].audioConsumer=item;\r\n            }else{\r\n              res[peerId].videoTrack=track;\r\n              res[peerId].videoConsumer=item;\r\n            }\r\n          }else{\r\n            res[peerId]={\r\n              device,\r\n              peerId,\r\n              audioTrack:kind=='audio'?track:null,\r\n              videoTrack:kind=='video'?track:null,\r\n              audioConsumer:kind=='audio'?item:null,\r\n              videoConsumer:kind=='video'?item:null\r\n            };\r\n          }\r\n        });\r\n        let others=[];\r\n        for(let key in res){\r\n          others.push(res[key]);\r\n        }\r\n        this.others=others;\r\n        console.log('this.others', this.others)\r\n      }else{\r\n        this.others=[];\r\n      }\r\n      console.log(this.others)\r\n      },\r\n      immediate: true,\r\n      deep: true\r\n    },\r\n    producerChange(newValue,oldValue){\r\n      const { _micProducer,_webcamProducer,_shareProducer,_device,_peerId }=newValue;\r\n      if(_webcamProducer||_shareProducer){\r\n        this.me={\r\n          // audioTrack:_micProducer.track,\r\n          videoTrack:_webcamProducer?_webcamProducer.track:_shareProducer.track,\r\n          audioProducer:_micProducer,\r\n          videoProducer:_webcamProducer?_webcamProducer:_shareProducer,\r\n          device:_device,\r\n          peerId:_peerId\r\n        };\r\n        console.log(this.me.videoTrack,'************************')\r\n      }else{\r\n        this.me={\r\n          // audioTrack:_micProducer.track,\r\n          videoTrack:null,\r\n          audioProducer:_micProducer,\r\n          videoProducer:null,\r\n          device:_device,\r\n          peerId:_peerId\r\n        };\r\n      }\r\n    },\r\n    consumerChange(newValue,oldValue){\r\n      // console.log('监听到con&&&&&&&&&&&&&&&&&&&&&&&', newValue)\r\n      // const { _consumersLength,_consumers }=newValue;\r\n      // if(_consumers.size>0){\r\n      //   const res= {};\r\n      //   _consumers.forEach(item=>{\r\n      //     const {appData:{device,peerId,socketId},kind,track}=item;\r\n      //     if(res[peerId]){\r\n      //       if(kind=='audio'){\r\n      //         res[peerId].audioTrack=track;\r\n      //         res[peerId].audioConsumer=item;\r\n      //       }else{\r\n      //         res[peerId].videoTrack=track;\r\n      //         res[peerId].videoConsumer=item;\r\n      //       }\r\n      //     }else{\r\n      //       res[peerId]={\r\n      //         device,\r\n      //         peerId,\r\n      //         audioTrack:kind=='audio'?track:null,\r\n      //         videoTrack:kind=='video'?track:null,\r\n      //         audioConsumer:kind=='audio'?item:null,\r\n      //         videoConsumer:kind=='video'?item:null\r\n      //       };\r\n      //     }\r\n      //   });\r\n      //   let others=[];\r\n      //   for(let key in res){\r\n      //     others.push(res[key]);\r\n      //   }\r\n      //   this.others=others;\r\n      //   console.log('this.others', this.others)\r\n      // }else{\r\n      //   this.others=[];\r\n      // }\r\n      // console.log(this.others)\r\n    },\r\n    'this.$store.state.personScenceInfo': {\r\n      handler(newValue) {\r\n        if(newValue) {\r\n          const data = JSON.parse(newValue);\r\n          this.scence = data.loc;\r\n          this.scenceStatus = data.act;\r\n        }\r\n      },\r\n      immediate: true,\r\n      deep: true\r\n    }\r\n  },\r\n  mounted() {\r\n    // 连接应用\r\n    this.connectAppli()\r\n    // 投屏 连接websocket\r\n    let roomId = '';\r\n    const peerId = this.peerId;\r\n    let queryInfo = this.$route.query;\r\n    if(queryInfo.roomId) {\r\n      roomId = queryInfo.roomId;\r\n    } else {\r\n      roomId = this.roomId;\r\n    }\r\n    let roomClient = new RoomClient({roomId,peerId});\r\n    roomClient.on(\"close\",(data)=>{\r\n      console.log('close', data)\r\n    })\r\n    roomClient.joinRoom();\r\n    this.roomClient=roomClient;\r\n    this.$store.commit('setRoomClient',roomClient);\r\n    \r\n  },\r\n  beforeUnmount() {\r\n    this.larksr.app.disConnect();\r\n    this.larksr = null;\r\n    this.$store.commit('setLarksr', null)\r\n    if(this.handsUpTimer) clearTimeout(this.handsUpTimer);\r\n    this.roomClient.close('页面销毁');\r\n    this.$store.commit('setRoomClient',null);\r\n  }\r\n}\r\n</script>\r\n<style lang='scss' scoped>\r\n.enter-appli {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  // z-index: 1000;\r\n  width: 100%;\r\n  height: 100%;\r\n  pointer-events: all;\r\n  .bottom-bar {\r\n    height: 98px;\r\n    position: absolute;\r\n    bottom: 10px;\r\n    left: 50%;\r\n    transform: translateX(-50%);\r\n    z-index: 100;\r\n    padding: 0 50px;\r\n    >div {\r\n      width: 98px;\r\n      height: 98px;\r\n      display: inline-block;\r\n      margin: 0 9px;\r\n      cursor: pointer;\r\n      >div {\r\n        width: 98px;\r\n        height: 98px;\r\n      }\r\n    }\r\n  }\r\n  .screen-dialog {\r\n    padding: 20px 10px 0 10px;\r\n    >div {\r\n      margin: 20px 0 0 0;\r\n      >div:nth-of-type(1) {\r\n        margin-right: 15px;\r\n      }\r\n      >div:nth-of-type(3) {\r\n        margin-left: 15px;\r\n      }\r\n      >div {\r\n        text-align: center;\r\n        >div {\r\n          width: 50px;\r\n          height: 50px;\r\n          border-radius: 50%;\r\n          border: 2px solid #cccccc66;\r\n          box-sizing: border-box;\r\n          background: #2e2e2e80;\r\n          text-align: center;\r\n          line-height: 50px;\r\n          margin: 0 auto;\r\n          cursor: pointer;\r\n          >span {\r\n            font-size: 25px;\r\n          }\r\n          >svg {\r\n            width: 30px;\r\n            height: 30px;\r\n            margin-top: 8px;\r\n          }\r\n        }\r\n        >p {\r\n          font-size: 12px;\r\n          margin-top: 5px;\r\n        }\r\n      }\r\n    }\r\n  }\r\n.action {\r\n  position: relative;\r\n  >div,.action-div {\r\n    width: 60px;\r\n    height: 60px;\r\n    border-radius: 50%;\r\n    text-align: center;\r\n    box-sizing: border-box;\r\n    color: #fff;\r\n    position: absolute;\r\n    >span {\r\n      display: block;\r\n      font-size: 12px;\r\n    }\r\n  }\r\n  >span {\r\n    display: block;\r\n    font-size: 12px;\r\n    margin-top: 3px;\r\n  }\r\n  >div:nth-of-type(2) {\r\n    top: -39px;\r\n    left: -40px;\r\n  }\r\n  >div:nth-of-type(3) {\r\n    top: -62px;\r\n    left: 18px;\r\n  }\r\n  >div:nth-of-type(4) {\r\n    top: -35px;\r\n    left: 74px;\r\n  }\r\n  >div:nth-of-type(5) {\r\n    top: 23px;\r\n    left: 91px;\r\n  }\r\n  \r\n  >div:nth-of-type(1) {\r\n    width: 98px;\r\n    height: 98px;\r\n    /* padding: 15px 0; */\r\n    >div {\r\n      width: 35px;\r\n      height: 35px;\r\n    }\r\n    >span {\r\n      display: block;\r\n      font-size: 12px;\r\n    }\r\n  }\r\n}\r\n  .wall {\r\n    width: 500px;\r\n    height: 300px;\r\n    margin: 0 auto;\r\n    background-color: azure;\r\n  }\r\n}\r\n</style>","import mod from \"-!../../node_modules/cache-loader/dist/cjs.js??ref--13-0!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js!../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./Screen.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../node_modules/cache-loader/dist/cjs.js??ref--13-0!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js!../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./Screen.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./Screen.vue?vue&type=template&id=775b2312&scoped=true&\"\nimport script from \"./Screen.vue?vue&type=script&lang=js&\"\nexport * from \"./Screen.vue?vue&type=script&lang=js&\"\nimport style0 from \"./Screen.vue?vue&type=style&index=0&id=775b2312&prod&lang=scss&scoped=true&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"775b2312\",\n  null\n  \n)\n\nexport default component.exports","export * from \"-!../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--9-oneOf-1-0!../../node_modules/css-loader/dist/cjs.js??ref--9-oneOf-1-1!../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../node_modules/postcss-loader/src/index.js??ref--9-oneOf-1-2!../../node_modules/sass-loader/dist/cjs.js??ref--9-oneOf-1-3!../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./Screen.vue?vue&type=style&index=0&id=775b2312&prod&lang=scss&scoped=true&\""],"sourceRoot":""}